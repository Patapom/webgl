<!DOCTYPE html>
<!-- 
  Passmw'Albedo
  A visual representation of the diffuse reflectances database
 -->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Passmw'Albedo</title>

<link rel="stylesheet" type="text/css" href="/css/jquery-ui-themes-1.9.2/themes/base/jquery.ui.all.css"/>
<link rel="stylesheet" type="text/css" href="/css/layout-default-1.3.0.css"/>
<link rel="stylesheet" type="text/css" href="style.css"/>

<!-- jQuery + plugs -->
<script type="text/javascript" src="/js/jquery-1.8.3.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.9.2.custom.js"></script>
<script type="text/javascript" src="/js/jquery.layout-1.3.0.js"></script>

<!-- patapi -->
<script type="text/javascript" src="../../WebGL/o3djs/base.js"></script>			<!-- Include a small part of the O3D library to help us with includes-->
<script type="text/javascript" src="../../WebGL/patapi/base.js"></script>			<!-- Include PatAPI-->

<!--  -->
<script type="text/javascript">
o3djs.require( 'patapi' );
o3djs.require( 'patapi.ui' );


// This is the list of enums declared in the C# database
//	public enum		TAGS_TYPE
// 	{
//		NONE,
// 		WOOD,
// 		STONE,
// 		SKIN,
// 		FABRIC,
// 		PAPER_CANVAS,
// 		PAINT,
// 		PLASTIC,
// 	}
// 
// 	public enum		TAGS_COLOR
// 	{
// 		NONE,
// 		BLACK,
// 		WHITE,
// 		GRAY,
// 		RED,
// 		GREEN,
// 		BLUE,
// 		YELLOW,
// 		CYAN,
// 		PURPLE,
// 		ORANGE,
// 	}
// 
// 	public enum		TAGS_SHADE
// 	{
// 		NONE,
// 		DARK,
// 		BRIGHT,
// 		NEUTRAL,
// 	}
// 
// 	[Flags]
// 	public enum		TAGS_NATURE
// 	{
// 		NONE = 0,
// 		NATURE = 256,
// 		LEAF = 1 | NATURE,
// 		SOIL = 2 | NATURE,
// 		BARK = 3 | NATURE,
// 	}
// 
// 	[Flags]
// 	public enum		TAGS_FURNITURE
// 	{
// 		NONE = 0,
// 		FURNITURE = 256,
// 		TABLE = 1 | FURNITURE,
// 		CHAIR = 2 | FURNITURE,
// 		DESK = 3 | FURNITURE,
// 		WARDROBE = 4 | FURNITURE,
// 		CABINET = 5 | FURNITURE,
// 	}
// 
// 	[Flags]
// 	public enum		TAGS_CONSTRUCTION
// 	{
// 		NONE = 0,
// 		CONSTRUCTION = 256,
// 		WALL = 1 | CONSTRUCTION,
// 		FLOOR = 2 | CONSTRUCTION,
// 		DOOR_WINDOW = 3 | CONSTRUCTION,
// 		ROAD_PAVEMENT = 4 | CONSTRUCTION,
// 	}
// 
// 	[Flags]
// 	public enum		TAGS_MODIFIERS
// 	{
// 		NONE = 0,
// 		WET = 1,
// 		DUSTY = 2,
// 		FROSTY = 4,
// 		VARNISHED = 8,
// 		OLD = 16,
// 		NEW = 32,
//	}
//
// Create the dynamic tags that are provided with the couple ("friendly name", "C# enum name"
var	Tags = [
	// Type
	{ N : "Wood", F : "WOOD" },
	{ N : "Stone", F : "STONE" },
	{ N : "Skin", F : "SKIN" },
	{ N : "Fabric", F : "FABRIC" },
	{ N : "Paper/Canvas", F : "PAPER_CANVAS" },
	{ N : "Paint", F : "PAINT" },
	{ N : "Plastic/Resin", F : "PLASTIC" },

	// Color
	{ N : "Black", F : "BLACK" },
	{ N : "White", F : "WHITE" },
	{ N : "Gray", F : "GRAY" },
	{ N : "Red", F : "RED" },
	{ N : "Green", F : "GREEN" },
	{ N : "Blue", F : "BLUE" },
	{ N : "Yellow", F : "YELLOW" },
	{ N : "Cyan", F : "CYAN" },
	{ N : "Purple", F : "PURPLE" },
	{ N : "Orange", F : "ORANGE" },

	// Shade
	{ N : "Dark", F : "DARK" },
	{ N : "Bright", F : "BRIGHT" },
	{ N : "Neutral", F : "NEUTRAL" },

	// Nature
	{ N : "Nature", F : "NATURE" },
	{ N : "Leaf", F : "LEAF" },
	{ N : "Soil", F : "SOIL" },
	{ N : "Bark", F : "BARK" },

	// Furniture
	{ N : "Furniture", F : "FURNITURE" },
	{ N : "Table", F : "TABLE" },
	{ N : "Chair", F : "CHAIR" },
	{ N : "Desk", F : "DESK" },
	{ N : "Wardrobe", F : "WARDROBE" },
	{ N : "Cabinet", F : "CABINET" },

	// Construction
	{ N : "Construction", F : "CONSTRUCTION" },
	{ N : "Wall", F : "WALL" },
	{ N : "Floor", F : "FLOOR" },
	{ N : "Door/Window", F : "DOOR_WINDOW" },
	{ N : "Road/Pavement", F : "ROAD_PAVEMENT" },

	// Modifiers
	{ N : "Wet", F : "WET," },
	{ N : "Dusty", F : "DUSTY," },
	{ N : "Frosty", F : "FROSTY" },
	{ N : "Varnished", F : "VARNISHED" },
	{ N : "Old", F : "OLD" },
	{ N : "New", F : "NEW" },
];

var	databasePath = "database/";
var	database;	// JSON database loads there

var	selectedEntry = null;

$(document).ready( function() {

	// Load JSON database
	try
	{
		var	FileContent = patapi.helpers.LoadFileSynchronous( databasePath + "database.json" );
		database = eval( '(' + FileContent + ')' );

		// Setup database
		database.Entries.forEach( function( _Entry ) {
			_Entry.FriendlyName_Lower = _Entry.FriendlyName.toLowerCase();
			_Entry.Description_Lower = _Entry.Description.toLowerCase();
			_Entry.Tags_Split = _Entry.Tags.split( ',' );
		} );
	}
	catch ( _e )
	{
		alert( "Error during database parsing: " + _e );
		return;
	}

	// Main database query function
	var	that = this;

	var	allowDatabaseQuery = false;
	function QueryDatabase() {
		if ( !database || !allowDatabaseQuery )
			return;

		// Prepare text search
		var	SearchForText = $( '#SearchTextBox' )[0].value;
			SearchForText = SearchForText.toLowerCase();
		var	EnableTextSearch = SearchForText != "";
		var	Keywords = SearchForText.split( ',' );
		for ( var i=0; i < Keywords.length; i++ )
			Keywords[i] = Keywords[i].trim();

		// Prepare tag search
		var	SearchTags = [];
		Tags.forEach( function( _Tag ) {
			if ( _Tag.checkBox.parameters.value )
				SearchTags.push( _Tag );
		} );

		// Collect all entries in the database that match our criteria
		var	Results = [];
		database.Entries.forEach( function( _Entry ) {

			// Filter by text
			var	found = false;
			if ( EnableTextSearch ) 
			{
				for ( var KeywordIndex=0; KeywordIndex < Keywords.length && !found; KeywordIndex++ )
				{
					var	Keyword = Keywords[KeywordIndex];
					found = _Entry.FriendlyName_Lower.indexOf( Keyword ) != -1;
					found |= _Entry.Description_Lower.indexOf( Keyword ) != -1;
				}				
			}

			// Filter by tags
			if ( SearchTags.length > 0 && _Entry.Tags_Split.length > 0 )
			{
				for ( var EntryTagIndex=0; EntryTagIndex < _Entry.Tags_Split.length && !found; EntryTagIndex++ )
				{
					var	EntryTag = _Entry.Tags_Split[EntryTagIndex];
					for ( var SearchTagIndex=0; SearchTagIndex < SearchTags.length && !found; SearchTagIndex++ )
					{
						var	SearchTag = SearchTags[SearchTagIndex].F;
						found = EntryTag == SearchTag;
					}
				}
			}

			if ( found )
				Results.push( _Entry );
		} );

		var	list = $( '#PanelResult' );

		list.html( '' );
		list.append( '<div>' + Results.length + ' entries found.</div>' );

		var	ExistingSelectionFound = false;
		Results.forEach( function( _Entry ) {

			ExistingSelectionFound |= _Entry == selectedEntry;

			list.append( '<div class="list-element ui-corner-all" onclick=""><span>' + _Entry.FriendlyName + '</span><img class="list-element-thumbnail" src="' + databasePath + _Entry.TextureInfos.ThumbnailFileName + '"/></div></div>' );
			_Entry.UIElement = list.children().last();
			_Entry.UIElement.click( function() {

				if ( selectedEntry )
					selectedEntry.UIElement.removeClass( 'list-element-selected' );

				selectedEntry = _Entry;
				selectedEntry.UIElement.addClass( "list-element-selected" );

				UpdateSelection();
			} );

		 } );

		// Clear selection if not contained in results anymore
		if ( !ExistingSelectionFound )
		{
			selectedEntry = null;
			UpdateSelection();
		}
	}

	// Create the tags
	var	TagIndex = 0;
	Tags.forEach( function( T ) {

		var	CheckBoxName = "TagCheckBox" + TagIndex;

		var	ContainerIndex = (TagIndex / 10) | 0;
		var	Container = $( "#Tags" + ContainerIndex );

//		Container.append( '<div id="' + CheckBoxName + '" class="UI-widget-label"><div class="t0"><span>' + T.N + '</span></div><div class="t1"><span class="ui-state-default ui-corner-all ui-checkbox"/></div></div>' );
		Container.append( '<div id="' + CheckBoxName + '" class="UI-widget-label"><div class="t1"><span class="ui-state-default ui-corner-all ui-checkbox"/></div><div class="t0"><span>' + T.N + '</span></div></div>' );

		T.checkBox = new patapi.ui.LabelCheckBox( {
			selector : "#" + CheckBoxName + " .t1 span",
			classSelected : "checkbox-checked",
			classUnSelected : "checkbox-unchecked",
			change : function( value ) {
				QueryDatabase();
			}
		} );		

		TagIndex++;
	} );

	// Create the search text box
	$( '#SearchTextBox' ).change( QueryDatabase );

	// Create the "Clear Tags" button
	function ClearTags() {
		allowDatabaseQuery = false;
		Tags.forEach( function( T ) {
			T.checkBox.set( false );
		} );
		allowDatabaseQuery = true;

		// Query only once
		QueryDatabase();
	}

	$( '#ClearTags' ).button().click( ClearTags );

	// Make the result panel fit the screen's height
	var $window = $(window).on( 'resize', function() {
		var	height = $(this).height() - $( '#PanelSearch' ).height();
			height -= 20;
		$( '#PanelResult' ).height( height );

		height = $(this).height() - $( '#PanelVisuTop' ).height();
		height -= 20;
		$( '#PanelVisuBottom' ).height( height );

    } ).trigger('resize'); //on page load

	// We can now authorize queries...
	allowDatabaseQuery = true;

} );

function		UpdateSelection()
{
	$( "#Texture" ).html( 
		selectedEntry ? '<img class="texture" src="' + databasePath + selectedEntry.TextureInfos.TextureFileName + '"/>'
					  : ''
	);

	function SetupSwatch( _$, _Swatch, _Name )
	{
		_$.swatch = _Swatch;
		if ( _Swatch )
		{
			_$.css( "background-color", "#" + _Swatch.Color );
			_$.click( function() {
				var	R = parseInt( "0x" + _Swatch.Color.slice( 0, 2 ) );
				var	G = parseInt( "0x" + _Swatch.Color.slice( 2, 4 ) );
				var	B = parseInt( "0x" + _Swatch.Color.slice( 4, 6 ) );

				var	Y = parseFloat( _Swatch.xyY.split( ';' )[2].trim() );

				$( '#SwatchInfos' ).html(	"Selected Swatch: " + _Name + " - Albedo=" + (100.0 * Y).toFixed( 2 ) + "%<br/>" +
											"<br/>" +
											"xyY = ( " + _Swatch.xyY.replace( /;/g, ',' ) + " )<br/>" +
											"sRGB [0,1] = ( " + _Swatch.RGB.replace( /;/g, ',' ) + " )<br/>" +
											"sRGB [0,255] = ( R=" + R + " G=" + G + " B=" + B + " )" );
			} );
		}
		else
		{
			_$.css( "background-color", "" );
			$( '#SwatchInfos' ).html( "" );
		}
	}

	SetupSwatch( $( "#SwatchMin" ), selectedEntry ? selectedEntry.TextureInfos.Swatches.Min : null, "Min" );
	SetupSwatch( $( "#SwatchMax" ), selectedEntry ? selectedEntry.TextureInfos.Swatches.Max : null, "Max" );
	SetupSwatch( $( "#SwatchAvg" ), selectedEntry ? selectedEntry.TextureInfos.Swatches.Avg : null, "Average" );

	for ( var CSIndex=0; CSIndex < 9; CSIndex++ )
		SetupSwatch( $( "#CS"+CSIndex ), selectedEntry && CSIndex < selectedEntry.TextureInfos.Swatches.Custom.length ? selectedEntry.TextureInfos.Swatches.Custom[CSIndex] : null, "Custom #"+CSIndex );
}

</script>
</head>

<body>

	<div id="ContainerGlobal">
		<div id="PanelLeft" class="panel">
			<!-- Contains the search & list panels -->
			<div id="PanelSearch" class="panel">
				<div id="SearchText">
					<div>
						<div>Search for: <input id='SearchTextBox' type="text" value="" for="SearchText_Input" style='margin-left:10px;'></div>
						<div><button id="ClearTags">Clear Tags</button></div>
					</div>
				</div>
				<div id="TagsBox">
					<div id="Tags0" class='tags-list'></div>
					<div id="Tags1" class='tags-list'></div>
					<div id="Tags2" class='tags-list'></div>
					<div id="Tags3" class='tags-list'></div>
				</div>
			</div>
			<div id="PanelResult" class="panel">
			</div>
		</div>
		<div id="PanelRight" class="panel">
			<!-- Contains the visualization panels -->
			<div id="PanelVisuTop" class="panel">
				<!-- Contains the 3D view -->
				3D VISU
			</div>
			<div id="PanelVisuBottom" class="panel">
				<!-- Contains the texture view -->
				<div id="TextureAndSwatches">
					<div id="Texture"></div>
					<div id="SwatchesAndInfos">
						<div id="AllSwatches">
							<div class="swatches-line">
								<div id="SwatchMin" class="swatch"></div>
								<div id="SwatchMax" class="swatch"></div>
								<div id="SwatchAvg" class="swatch"></div>
							</div>
							<div id="CustomSwatches">
								<div class="swatches-line"">
									<div id="CS0" class="swatch"></div>
									<div id="CS1" class="swatch"></div>
									<div id="CS2" class="swatch"></div>
								</div>
								<div class="custom-swatches-line"">
									<div id="CS3" class="swatch"></div>
									<div id="CS4" class="swatch"></div>
									<div id="CS5" class="swatch"></div>
								</div>
								<div class="custom-swatches-line"">
									<div id="CS6" class="swatch"></div>
									<div id="CS7" class="swatch"></div>
									<div id="CS8" class="swatch"></div>
								</div>
							</div>
						</div>
						<div id="SwatchInfos">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

</body>
</html>
